[{"path":"https://toddmccready.github.io/disize/LICENSE.html","id":null,"dir":"","previous_headings":"","what":"MIT License","title":"MIT License","text":"Copyright (c) 2025 disize authors Permission hereby granted, free charge, person obtaining copy software associated documentation files (“Software”), deal Software without restriction, including without limitation rights use, copy, modify, merge, publish, distribute, sublicense, /sell copies Software, permit persons Software furnished , subject following conditions: copyright notice permission notice shall included copies substantial portions Software. SOFTWARE PROVIDED “”, WITHOUT WARRANTY KIND, EXPRESS IMPLIED, INCLUDING LIMITED WARRANTIES MERCHANTABILITY, FITNESS PARTICULAR PURPOSE NONINFRINGEMENT. EVENT SHALL AUTHORS COPYRIGHT HOLDERS LIABLE CLAIM, DAMAGES LIABILITY, WHETHER ACTION CONTRACT, TORT OTHERWISE, ARISING , CONNECTION SOFTWARE USE DEALINGS SOFTWARE.","code":""},{"path":"https://toddmccready.github.io/disize/articles/a-bulk-experiment.html","id":"dependencies","dir":"Articles","previous_headings":"","what":"Dependencies","title":"A Bulk Experiment","text":"","code":"library(disize) library(curl) #> Using libcurl 8.5.0 with OpenSSL/3.0.13 library(R.utils) #> Loading required package: R.oo #> Loading required package: R.methodsS3 #> R.methodsS3 v1.8.2 (2022-06-13 22:00:14 UTC) successfully loaded. See ?R.methodsS3 for help. #> R.oo v1.27.1 (2025-05-02 21:00:05 UTC) successfully loaded. See ?R.oo for help. #>  #> Attaching package: 'R.oo' #> The following object is masked from 'package:R.methodsS3': #>  #>     throw #> The following objects are masked from 'package:methods': #>  #>     getClasses, getMethods #> The following objects are masked from 'package:base': #>  #>     attach, detach, load, save #> R.utils v2.13.0 (2025-02-24 21:20:02 UTC) successfully loaded. See ?R.utils for help. #>  #> Attaching package: 'R.utils' #> The following object is masked from 'package:utils': #>  #>     timestamp #> The following objects are masked from 'package:base': #>  #>     cat, commandArgs, getOption, isOpen, nullfile, parse, use, warnings library(data.table)"},{"path":"https://toddmccready.github.io/disize/articles/a-bulk-experiment.html","id":"the-dataset","dir":"Articles","previous_headings":"","what":"The dataset","title":"A Bulk Experiment","text":"dataset consists purified macrophage subtype(“Mac2”, supposedly ‘activated’ state) partitioned four groups exposed different conditions. authors offer information samples processed: sorted Mac2 cells divided four groups stimulated 3-h time point concentrations previously described. , RNA extracted using RNeasy Plus Micro Kit per manufacturer instructions. Poly()mRNA isolated using mRNA Capture Beads 2.0 (Yeasen Cat.12629ES, CHN) two rounds purification, followed RNA fragmentation magnesium ions 94°C (Yeasen Cat.12340ES97, CHN). RNA sequencing library preparation performed using TruSeq RNA Library Prep Kit v2 (Illumina). Sequencing carried paired-end 2×150 bp (PE150) Illumina Novaseq™ X Plus (LC-Bio Technologies). TruSeq RNA Library Prep Kit involves “tagging” transcripts barcodes identify distinct samples, allowing prepared cDNA libraries pooled together sequencing. Since batch-effects usually attributed separate sequencing runs, expect small batch-effects present dataset define “batch” unit subjected RNA extraction(processing). Let us test hypothesis:","code":""},{"path":"https://toddmccready.github.io/disize/articles/a-bulk-experiment.html","id":"downloading-the-data","dir":"Articles","previous_headings":"","what":"Downloading the data","title":"A Bulk Experiment","text":"","code":"# Download counts and construct metadata counts_path <- curl::curl_download(     url = \"https://www.ncbi.nlm.nih.gov/geo/download/?acc=GSE273924&format=file&file=GSE273924%5Fraw%5Fcounts%2Etsv%2Egz\",     destfile = paste0(tempdir(), \"/counts.tsv.gz\") ) counts <- data.table::fread(counts_path)  metadata <- data.frame(     \"sample_id\" = c(colnames(counts)[-1]),     \"condition\" = factor(rep(c(\"control\", \"lps\", \"nelps\", \"ne\"), each = 3)) )  # Coerce to formatted matrix gene_names <- counts$gene_id counts <- t(as.matrix(counts[,-1])) colnames(counts) <- gene_names"},{"path":"https://toddmccready.github.io/disize/articles/a-bulk-experiment.html","id":"running-disize","dir":"Articles","previous_headings":"","what":"Running disize","title":"A Bulk Experiment","text":"metadata contains information experimental design: dataset, study primarily interested effect condition expression, thus formula input disize : can finally run disize get estimated size factors: Evidently batch-effect indeed small across samples! samples “NELPS1” “NELPS2” seem processed slightly worse, otherwise estimated size factors approximately (within ~0.1). can confirm estimates rerunning disize larger n_feats: Indeed estimates remain largely .","code":"print(metadata) #>    sample_id condition #> 1      Ctrl1   control #> 2      Ctrl2   control #> 3      Ctrl3   control #> 4       LPS1       lps #> 5       LPS2       lps #> 6       LPS3       lps #> 7     NELPS1     nelps #> 8     NELPS2     nelps #> 9     NELPS3     nelps #> 10       NE1        ne #> 11       NE2        ne #> 12       NE3        ne design_formula <- ~ condition size_factors <- disize::disize(     design_formula,     counts,     metadata,     batch_name = \"sample_id\" ) #> Formatting data... #> ar: creating stan/lib/stan_math/lib/sundials_6.1.1/lib/libsundials_nvecserial.a #> ar: creating stan/lib/stan_math/lib/sundials_6.1.1/lib/libsundials_cvodes.a #> ar: creating stan/lib/stan_math/lib/sundials_6.1.1/lib/libsundials_idas.a #> ar: creating stan/lib/stan_math/lib/sundials_6.1.1/lib/libsundials_kinsol.a #> /home/runner/.cmdstan/cmdstan-2.36.0/stan/lib/stan_math/lib/tbb_2020.3/build/Makefile.tbb:28: CONFIG: cfg=release arch=intel64 compiler=gcc target=linux runtime=cc13.3.0_libc2.39_kernel6.11.0 #> In file included from ../tbb_2020.3/src/tbb/concurrent_hash_map.cpp:17: #> ../tbb_2020.3/include/tbb/concurrent_hash_map.h:347:23: warning: ‘template<class _Category, class _Tp, class _Distance, class _Pointer, class _Reference> struct std::iterator’ is deprecated [-Wdeprecated-declarations] #>   347 |         : public std::iterator<std::forward_iterator_tag,Value> #>       |                       ^~~~~~~~ #> In file included from /usr/include/c++/13/bits/stl_construct.h:61, #>                  from /usr/include/c++/13/bits/stl_tempbuf.h:61, #>                  from /usr/include/c++/13/memory:66, #>                  from ../tbb_2020.3/include/tbb/tbb_stddef.h:452, #>                  from ../tbb_2020.3/include/tbb/concurrent_hash_map.h:23: #> /usr/include/c++/13/bits/stl_iterator_base_types.h:127:34: note: declared here #>   127 |     struct _GLIBCXX17_DEPRECATED iterator #>       |                                  ^~~~~~~~ #> cc1plus: note: unrecognized command-line option ‘-Wno-unknown-warning-option’ may have been intended to silence earlier diagnostics #> In file included from ../tbb_2020.3/src/tbb/concurrent_queue.cpp:22: #> ../tbb_2020.3/include/tbb/internal/_concurrent_queue_impl.h:749:21: warning: ‘template<class _Category, class _Tp, class _Distance, class _Pointer, class _Reference> struct std::iterator’ is deprecated [-Wdeprecated-declarations] #>   749 |         public std::iterator<std::forward_iterator_tag,Value> { #>       |                     ^~~~~~~~ #> In file included from /usr/include/c++/13/bits/stl_construct.h:61, #>                  from /usr/include/c++/13/bits/stl_tempbuf.h:61, #>                  from /usr/include/c++/13/memory:66, #>                  from ../tbb_2020.3/include/tbb/tbb_stddef.h:452, #>                  from ../tbb_2020.3/src/tbb/concurrent_queue.cpp:17: #> /usr/include/c++/13/bits/stl_iterator_base_types.h:127:34: note: declared here #>   127 |     struct _GLIBCXX17_DEPRECATED iterator #>       |                                  ^~~~~~~~ #> ../tbb_2020.3/include/tbb/internal/_concurrent_queue_impl.h:1013:21: warning: ‘template<class _Category, class _Tp, class _Distance, class _Pointer, class _Reference> struct std::iterator’ is deprecated [-Wdeprecated-declarations] #>  1013 |         public std::iterator<std::forward_iterator_tag,Value> { #>       |                     ^~~~~~~~ #> /usr/include/c++/13/bits/stl_iterator_base_types.h:127:34: note: declared here #>   127 |     struct _GLIBCXX17_DEPRECATED iterator #>       |                                  ^~~~~~~~ #> cc1plus: note: unrecognized command-line option ‘-Wno-unknown-warning-option’ may have been intended to silence earlier diagnostics #> Estimating size factors... (Max ETA: ~109.2s) #> Finised in 96.8s! print(size_factors) #>        Ctrl1        Ctrl2        Ctrl3         LPS1         LPS2         LPS3  #>  0.082340728  0.003553523 -0.086471855  0.085881138  0.012432106  0.100065963  #>          NE1          NE2          NE3       NELPS1       NELPS2       NELPS3  #> -0.069011169  0.036273935  0.106796358 -0.162830180 -0.134203900 -0.021313770 size_factors_2 <- disize::disize(     design_formula,     counts,     metadata,     batch_name = \"sample_id\",     n_feats = 15000 ) #> Formatting data... #> Estimating size factors... (Max ETA: ~161.7s) #> Finised in 143.4s! print(size_factors_2) #>        Ctrl1        Ctrl2        Ctrl3         LPS1         LPS2         LPS3  #>  0.095303742  0.005168706 -0.083965484  0.073874335 -0.008215053  0.087963097  #>          NE1          NE2          NE3       NELPS1       NELPS2       NELPS3  #> -0.044352619  0.055490226  0.123255579 -0.181307332 -0.149171063 -0.025856786"},{"path":"https://toddmccready.github.io/disize/articles/a-bulk-experiment.html","id":"downstream-analysis","dir":"Articles","previous_headings":"","what":"Downstream analysis","title":"A Bulk Experiment","text":"WIP","code":""},{"path":"https://toddmccready.github.io/disize/articles/disize.html","id":"an-example-with-deseq2","dir":"Articles","previous_headings":"","what":"An example with DESeq2","title":"An introduction to disize","text":"see disize action, analyzing following dataset pasilla package DESeq2.","code":"suppressPackageStartupMessages({     library(pasilla)     library(dplyr)     library(disize)     library(DESeq2) })"},{"path":"https://toddmccready.github.io/disize/articles/disize.html","id":"reading-in-data","dir":"Articles","previous_headings":"An example with DESeq2","what":"Reading in data","title":"An introduction to disize","text":"","code":"# Grab filepaths counts_path <- system.file(     \"extdata\",     \"pasilla_gene_counts.tsv\",     package=\"pasilla\",     mustWork=TRUE ) metadata_path <- system.file(     \"extdata\",     \"pasilla_sample_annotation.csv\",     package=\"pasilla\",     mustWork=TRUE )  # Read in data counts <- as.matrix(read.csv(counts_path, sep = \"\\t\", row.names = \"gene_id\")) |>     t()  metadata <- read.csv(metadata_path) metadata <- metadata |>     dplyr::mutate(obs_id = sub(\"fb\", \"\", metadata$file)) |>     dplyr::select(obs_id, condition, type) |>     dplyr::mutate(across(c(condition, type), as.factor)) |>     dplyr::mutate(         id_1 = interaction(metadata$type, metadata$condition, sep = \":\"),         id_2 = obs_id     )"},{"path":"https://toddmccready.github.io/disize/articles/disize.html","id":"inspecting-the-study-design","dir":"Articles","previous_headings":"An example with DESeq2","what":"Inspecting the study design","title":"An introduction to disize","text":"dataset derived study investigating effect various RNA binding proteins (RBPs) alternative splicing regulation. authors partitioned D. melanogaster cells two different conditions: observations condition = treated treated dsRNAs knockdown expression via RNAi, condition = untreated left alone control. Additionally, two sets duplicates processed parallel condition different kits used library preparation (producing single-read vs paired-end reads). Thus, suitable definition “batch” might interaction type condition. However, easy double-check making batch definition granular possible (sample denotes batch). metadata object contains information experimental design: Evidently, one sample thrown away! absence batch-effects interested effects condition, design_formula :","code":"print(metadata) #>       obs_id condition        type                  id_1       id_2 #> 1   treated1   treated single-read   single-read:treated   treated1 #> 2   treated2   treated  paired-end    paired-end:treated   treated2 #> 3   treated3   treated  paired-end    paired-end:treated   treated3 #> 4 untreated1 untreated single-read single-read:untreated untreated1 #> 5 untreated2 untreated single-read single-read:untreated untreated2 #> 6 untreated3 untreated  paired-end  paired-end:untreated untreated3 #> 7 untreated4 untreated  paired-end  paired-end:untreated untreated4 design_formula <- ~ condition"},{"path":"https://toddmccready.github.io/disize/articles/disize.html","id":"estimating-size-factors","dir":"Articles","previous_headings":"An example with DESeq2","what":"Estimating size factors","title":"An introduction to disize","text":"","code":"# First batch definition size_factors_1 <- disize::disize(     design_formula,     counts,     metadata,     batch_name = \"id_1\",     obs_name = \"obs_id\" # needed to order 'counts' correctly ) #> Formatting data... #> Estimating size factors... (Max ETA: ~66.7s) #> Finised in 60s!  # Second batch definition size_factors_2 <- disize::disize(     design_formula,     counts,     metadata,     batch_name = \"id_2\",     obs_name = \"obs_id\" ) #> Formatting data... #> Estimating size factors... (Max ETA: ~71.5s) #> Finised in 62.6s!"},{"path":"https://toddmccready.github.io/disize/articles/disize.html","id":"comparing-batch-definitions","dir":"Articles","previous_headings":"An example with DESeq2 > Estimating size factors","what":"Comparing batch definitions","title":"An introduction to disize","text":"Although similarities, enough difference observations using granular definition may bring needed precision.","code":"size_factors <- data.frame(     obs_id = metadata$obs_id,     def_1 = unname(size_factors_1[metadata$id_1]),     def_2 = unname(size_factors_2[metadata$id_2]) )  print(size_factors) #>       obs_id      def_1      def_2 #> 1   treated1  0.3576840  0.4337995 #> 2   treated2 -0.3341442 -0.3501711 #> 3   treated3 -0.3341442 -0.2633270 #> 4 untreated1  0.2187259  0.0424296 #> 5 untreated2  0.2187259  0.5012903 #> 6 untreated3 -0.4950414 -0.5118620 #> 7 untreated4 -0.4950414 -0.3706849"},{"path":"https://toddmccready.github.io/disize/articles/disize.html","id":"running-deseq","dir":"Articles","previous_headings":"An example with DESeq2","what":"Running DESeq","title":"An introduction to disize","text":"size factors inserted DESeqDataSet object, analysis proceeds normally.","code":"# Constructing DESeqDataSet object dds <- DESeq2::DESeqDataSetFromMatrix(     countData = t(counts[metadata$obs_id, ]),     colData = metadata,     design = design_formula ) DESeq2::sizeFactors(dds) <- exp(size_factors_2) # Insert size factors  # Run analysis dds <- DESeq2::DESeq(dds) #> using pre-existing size factors #> estimating dispersions #> gene-wise dispersion estimates #> mean-dispersion relationship #> final dispersion estimates #> fitting model and testing  # Print results print(results(dds)) #> log2 fold change (MLE): condition untreated vs treated  #> Wald test p-value: condition untreated vs treated  #> DataFrame with 14599 rows and 6 columns #>                baseMean log2FoldChange     lfcSE       stat    pvalue      padj #>               <numeric>      <numeric> <numeric>  <numeric> <numeric> <numeric> #> FBgn0000003    0.185893     -1.0167939  3.804518 -0.2672596 0.7892693        NA #> FBgn0000008  102.946483      0.0152384  0.221325  0.0688507 0.9451085  0.990455 #> FBgn0000014    1.141458      0.5268319  2.114015  0.2492092 0.8031990        NA #> FBgn0000015    0.917912      1.8982548  2.060040  0.9214650 0.3568077        NA #> FBgn0000017 4711.140900      0.2564267  0.126126  2.0330989 0.0420425  0.234177 #> ...                 ...            ...       ...        ...       ...       ... #> FBgn0261571 9.25775e-02    -0.87944028  3.809549 -0.2308515  0.817430        NA #> FBgn0261572 6.71659e+00     0.97726858  0.762876  1.2810322  0.200182  0.579617 #> FBgn0261573 2.42519e+03     0.00375871  0.115481  0.0325484  0.974035  0.995694 #> FBgn0261574 5.25085e+03     0.00508216  0.190924  0.0266188  0.978764  0.997642 #> FBgn0261575 1.15072e+01    -0.13557712  0.928857 -0.1459612  0.883952  0.973689"},{"path":"https://toddmccready.github.io/disize/authors.html","id":null,"dir":"","previous_headings":"","what":"Authors","title":"Authors and Citation","text":"Todd McCready. Author, maintainer.","code":""},{"path":"https://toddmccready.github.io/disize/authors.html","id":"citation","dir":"","previous_headings":"","what":"Citation","title":"Authors and Citation","text":"McCready T (2025). disize: Design Informed Size Factor Estimation. R package version 0.4.20, https://toddmccready.github.io/disize/.","code":"@Manual{,   title = {disize: Design Informed Size Factor Estimation},   author = {Todd McCready},   year = {2025},   note = {R package version 0.4.20},   url = {https://toddmccready.github.io/disize/}, }"},{"path":"https://toddmccready.github.io/disize/index.html","id":"disize","dir":"","previous_headings":"","what":"Design Informed Size Factor Estimation","title":"Design Informed Size Factor Estimation","text":"Design informed size factor estimation (disize) normalization method meant alternative DESeq2’s median rations edgeR’s trimmed mean M values","code":""},{"path":"https://toddmccready.github.io/disize/index.html","id":"installation","dir":"","previous_headings":"","what":"Installation","title":"Design Informed Size Factor Estimation","text":"disize yet CRAN, installation one-liner install.packages:","code":""},{"path":"https://toddmccready.github.io/disize/index.html","id":"with-remotes","dir":"","previous_headings":"","what":"With remotes","title":"Design Informed Size Factor Estimation","text":"","code":"# Install disize remotes::install_github(\"https://github.com/toddmccready/disize\")  # Set up CmdStan toolchain cmdstanr::install_cmdstan()"},{"path":"https://toddmccready.github.io/disize/index.html","id":"with-rv","dir":"","previous_headings":"","what":"With rv","title":"Design Informed Size Factor Estimation","text":"Add following entries rproject.toml file(already present): sync project: finally install CmdStan toolchain R:","code":"repositories = [     # ...     { alias = \"STAN\", url = \"https://stan-dev.r-universe.dev\" },     # ... ]  # ...  dependencies = [     # ...     { name = \"disize\", git = \"https://github.com/toddmccready/disize\", tag = \"v0.4.20\" },     # ... ] rv sync cmdstanr::install_cmdstan()"},{"path":"https://toddmccready.github.io/disize/index.html","id":"implementation","dir":"","previous_headings":"","what":"Implementation","title":"Design Informed Size Factor Estimation","text":"Internally, disize uses Stan fit Bayesian model jointly estimates effect covariates(structured according design_formula) expression confounding batch-effects: \\begin{aligned}     \\vec{Y}_g &\\sim \\text{NegBinom}(\\vec{\\mu}_g, \\phi) \\\\     \\log \\vec{\\mu}_g &= \\vec{\\alpha} + \\mathbf{X} \\vec{\\beta}_g + \\mathbf{Z}\\vec{b}_g + \\vec{o} \\\\         &= \\vec{\\alpha} + \\mathbf{X} \\vec{\\beta}_g + \\mathbf{Z}\\vec{b}_g + \\mathbf{B} \\vec{s} \\\\     \\vec{\\beta}_g &\\sim \\text{Normal}(\\vec{0}, \\mathbf{G}) \\end{aligned} \\vec{Y}_g denotes vector counts gene g observations, realized distribution parameterized effect covariates (\\vec{\\alpha} + \\mathbf{X} \\vec{\\beta}_g + \\mathbf{Z}\\vec{b}_g) batch-effects (\\mathbf{B} \\vec{s}). experimental design specified R formula (design_formula) constructs “fixed-effects” model matrix \\mathbf{X} (without intercept) “random-effects” model matrix \\mathbf{Z}; regular GLMM. confounding batch-effect essentially unknown offset \\vec{o} = \\mathbf{B} \\vec{s}, \\mathbf{B} specifies batch membership observation \\vec{s} contains “size factors” scale true magnitude expression. face, however, model identifiable experimental designs (often batch ID perfectly collinear predictor interaction predictors). identifiability issue overcome assuming fraction features significantly affected covariates measured experiment; words, estimated coefficients model matrices specifying experimental design sparse. assumption encoded final model placing distinct horseshoe priors model coefficients (fixed- random-effects). allows priors learned independently using large number features measured RNAseq experiments.","code":""},{"path":"https://toddmccready.github.io/disize/reference/disize.html","id":null,"dir":"Reference","previous_headings":"","what":"Design-informed size factor estimation — disize","title":"Design-informed size factor estimation — disize","text":"Design-informed size factor estimation","code":""},{"path":"https://toddmccready.github.io/disize/reference/disize.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Design-informed size factor estimation — disize","text":"","code":"disize(   design_formula,   counts,   metadata,   batch_name = \"batch_id\",   obs_name = \"obs_id\",   n_feats = min(10000L, ncol(counts)),   n_subset = 50L,   n_iters = \"auto\",   n_threads = max(1, parallel::detectCores() - 2L),   grainsize = ceiling(n_feats/n_threads),   init_alpha = 1e-06,   verbose = 3L )"},{"path":"https://toddmccready.github.io/disize/reference/disize.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Design-informed size factor estimation — disize","text":"design_formula formula describing experimental design. counts (obsservation x feature) count matrix. metadata dataframe containing sample metadata. batch_name identifier batch column 'metadata', defaults \"batch_id\". obs_name identifier observation column 'metadata', defaults \"obs_id\". n_feats number features used estimation, defaults automatically choosing based heuristic. n_subset number observations per experimental unit used estimation, defaults 50. n_iters number iterations used single optimization pass. n_threads number threads use parallel processing. grainsize grainsize used partitioning data across threads ( highly encouraged leave default value). verbose verbosity level (1: errors, 2: also allows warnings, 3: also allows messages, 4: also prints additional output useful debugging).","code":""},{"path":"https://toddmccready.github.io/disize/reference/disize.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Design-informed size factor estimation — disize","text":"named numeric vector containing size factor point estimates.","code":""}]
